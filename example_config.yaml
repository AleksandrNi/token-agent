# ===================================
# SETTINGS - defaults and server config
# ===================================
settings:
  retry:
    attempts: 4
    base_delay_ms: 200
    max_delay_ms: 5000
  safety_margin_seconds: 10
  server:
    uds_path: "/run/token-service.sock"
    permissions: "0600"
  observability:
    metrics_endpoint: "/metrics"
    log_level: "info"

# ===================================
# SOURCES
# ===================================
sources:
  # Metadata token from cloud VM
  metadata:
    type: http
    request:
      url: "http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"
      method: GET
      headers:
        "Metadata-Flavor":
          value: "Google"
    parse:
      body:
        - token: "/access_token"
        - expires_at:
            pointer: "/expires_in"
            type: int

  # CPL token exchanged from metadata token
  cpl:
    type: http
    inputs: ["metadata"]
    request:
      url: "https://cpl.internal.local/issueToken"
      method: POST
      headers:
        Authorization:
          sources: ["metadata"]
          template: "Bearer {{metadata.body.token}}"
          required: true
        "Content-Type":
          value: "application/json"
      body:
        subject_token:
          sources: ["metadata"]
          template: "{{metadata.body.token}}"
        subject_token_type:
          value: "urn:ietf:params:oauth:token-type:access_token"
    parse:
      body:
        - token: "/access_token"
        - expires_at:
            pointer: "/expires_in"
            type: int

  # Client credentials token (optional multi-source)
  client_creds:
    type: oauth2
    grant_type: client_credentials
    request:
      url: "https://idp.example.com/oauth2/token"
      method: POST
      form:
        client_id:
          env: CLIENT_ID
        client_secret:
          file: /etc/secrets/client_secret
        scope:
          value: "metrics.write"
    parse:
      body:
        - token: "/access_token"
        - expires_at:
            pointer: "/expires_in"
            type: int

# ===================================
# SINKS - write tokens to files
# ===================================
sinks:
  metadata_file:
    type: file
    inputs: ["metadata"]
    path: "/run/token-service/metadata.token"
    mode: 0600

  cpl_file:
    type: file
    inputs: ["cpl"]
    path: "/run/token-service/cpl.token"
    mode: 0600

  client_file:
    type: file
    inputs: ["client_creds"]
    path: "/run/token-service/client.token"
    mode: 0600
    watch: true

# ===================================
# ENDPOINTS - UDS for local apps + metrics
# ===================================
endpoints:
  metadata_socket:
    type: uds
    inputs: ["metadata"]
    path: "/token/metadata"

  cpl_socket:
    type: uds
    inputs: ["cpl"]
    path: "/token/cpl"

  client_socket:
    type: uds
    inputs: ["client_creds"]
    path: "/token/client"

  metrics:
    type: http
    path: "/metrics"

# ===================================
# USAGE EXAMPLES
# ===================================
# Multi-source header example:
# Authorization: "Bearer {{metadata.body.token}}-{{cpl.body.token}}"
# Optional fallback example:
# X-Optional-Header: "{{optional_source.body.token}} ?? ''"
# Fail-fast required header:
# Authorization.required: true
